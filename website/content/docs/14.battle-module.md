---
title: Battle Module
description: Documentation du syst√®me de combat final contre l'√âtranger
---

## Vue d'ensemble

Le module **Battle** est l'atelier final de l'exp√©rience Rift. Apr√®s avoir collect√© les 4 morceaux de faille, les deux agents affrontent l'√âtranger dans un combat bas√© sur le timing et la reconnaissance d'objets dessin√©s.

La page de combat est accessible via `/battle`.

## Architecture

```mermaid
graph LR
    subgraph "Hardware"
        ESP_P[ESP Parent<br/>LED Bleu]
        ESP_C[ESP Enfant<br/>LED Rose]
    end
    
    subgraph "Swift App"
        CAM[2 Cam√©ras]
        AI[Reconnaissance IA]
    end
    
    subgraph "Web"
        BATTLE[/battle]
    end
    
    ESP_P <--> SERVER[WebSocket<br/>Server]
    ESP_C <--> SERVER
    CAM --> AI --> SERVER
    SERVER <--> BATTLE
```

## Machine d'√âtats

```mermaid
stateDiagram-v2
    [*] --> IDLE
    IDLE --> APPEARING: rift_part_count = 4
    APPEARING --> FIGHTING: apr√®s 5s
    FIGHTING --> HIT: contre valid√© + boutons press√©s
    HIT --> FIGHTING: HP > 0, round < 5
    HIT --> WEAKENED: HP = 0 ou round = 5
    WEAKENED --> CAPTURED: 2 cages RFID d√©tect√©es
    CAPTURED --> DONE: apr√®s 5s
```

| √âtat | LEDs | Action Requise |
| :--- | :--- | :--- |
| `IDLE` | √âteintes | Attente `rift_part_count=4` |
| `APPEARING` | Blanc ‚Üí Rose/Bleu | Intro boss (5s) |
| `FIGHTING` | Couleur r√¥le | Dessiner le contre + appuyer bouton |
| `HIT` | Clignotement rapide | Animation de d√©g√¢t |
| `WEAKENED` | Clignotement lent violet | Poser les cages RFID |
| `CAPTURED` | Vert fixe | Victoire ! |
| `DONE` | √âteintes | Fin de l'atelier |

## D√©roul√© Complet

### 1. D√©clenchement
- Le serveur envoie `rift_part_count: 4`
- Les LEDs des deux ESP s'allument en **blanc**
- La page `/battle` affiche la vid√©o d'apparition du boss

### 2. Transition (5 secondes)
- Apr√®s 5s, les LEDs changent de couleur :
  - **Parent** : Bleu fonc√©
  - **Enfant** : Rose
- La barre de vie du boss appara√Æt (5 segments)

### 3. Combat (5 rounds)
√Ä chaque round :
1. Le boss lance une **attaque** (affich√© sur l'√©cran)
2. Les agents doivent **dessiner le contre** devant les cam√©ras
3. L'app Swift reconna√Æt le dessin et valide
4. Les **boutons arcade s'allument** quand le contre est valid√©
5. Les agents appuient sur les boutons **au bon moment**
6. Si r√©ussi : d√©g√¢ts au boss, HP -1

| Attaque | Contre |
| :--- | :--- |
| Lightning | Bouclier |
| Fire | Eau |
| Ice | Feu |
| Shadow | Lumi√®re |
| Void | √âp√©e |

### 4. Boss Affaibli
- Quand HP = 0, le boss est vuln√©rable
- Texte : *"L'√âtranger est affaibli, posez les cages !"*
- Les agents doivent poser les **cages sur les capteurs RFID**

### 5. Capture
- Quand les 2 cages sont d√©tect√©es ‚Üí Boss captur√©
- LEDs vertes, vid√©o de victoire
- Texte final avec instructions

## Protocole JSON

### Cl√©s Battle Simplifi√©es

```json
"battle_state": string | null,                    // idle, appearing, fighting, hit, weakened, captured, done
"battle_drawing_dream_recognised": bool | null,   // Dessin reconnu par cam√©ra Dream
"battle_drawing_nightmare_recognised": bool | null, // Dessin reconnu par cam√©ra Nightmare
"battle_hit_confirmed": bool | null,              // Hit confirm√©
"battle_cage_nightmare": bool | null,             // Cage RFID d√©tect√©e (Nightmare)
"battle_cage_dream": bool | null,                 // Cage RFID d√©tect√©e (Dream)
"battle_video_play": string | null,               // Vid√©o √† jouer
"battle_music_play": string | null                // Musique √† jouer
```

### Payloads Swift App ‚Üí Serveur

```json
{
  "device_id": "battle-camera-mac",
  "battle_drawing_dream_recognised": true,
  "battle_drawing_nightmare_recognised": false
}
```

### Payloads ESP ‚Üí Serveur

```json
{
  "device_id": "BATTLE-NIGHTMARE-ESP",
  "battle_state": "fighting",
  "battle_cage_nightmare": true
}
```

### Payloads Serveur ‚Üí Page Web

```json
{
  "battle_state": "hit",
  "battle_hit_confirmed": true,
  "battle_video_play": "video-battle-hit.mp4"
}
```

## Hardware

### ESP32 (x2)

| Composant | Pin Nightmare | Pin Dream |
| :--- | :--- | :--- |
| LED Strip (WS2812B) | GPIO 27 | GPIO 27 |
| Arcade Button | GPIO 26 | GPIO 26 |
| Button LED | GPIO 25 | GPIO 25 |
| RFID (SPI) | Standard | Standard |

### Couleurs LED

| √âtat | Couleur RGB |
| :--- | :--- |
| Intro | `(255, 255, 255)` Blanc |
| Nightmare | `(255, 105, 180)` Rose |
| Dream | `(25, 25, 112)` Bleu fonc√© |
| Hit | `(255, 200, 0)` Jaune |
| Affaibli | `(128, 0, 128)` Violet |
| Victoire | `(0, 255, 100)` Vert |

## Fichiers Vid√©o

√Ä placer dans `website/public/` :

| Fichier | Usage |
| :--- | :--- |
| `video-battle-appearing.mp4` | Apparition du boss |
| `video-battle-fighting.mp4` | Combat en cours |
| `video-battle-hit.mp4` | Boss touch√© |
| `video-battle-weakened.mp4` | Boss affaibli |
| `video-battle-captured.mp4` | Boss captur√© |

## Fichiers Source

### ESP32
- `iot/esp/src/Core/Battle/` - Module Battle
- `iot/esp/src/Core/Controller/Battle/` - Controllers Nightmare/Dream

### Swift App (macOS) - Battle MLX Cam
- `iot/battle-mlx-cam/` - Application cam√©ra
- `back/main_headless.py` - Point d'entr√©e headless (sans GUI)
- `back/src/battle_service.py` - Service de traitement d'images
- `back/src/web_server.py` - API Flask + SocketIO (port 5010)
- `front/pages/config.vue` - Page de configuration distante

### Lancement
```bash
cd iot/battle-mlx-cam
python start_battle.py
```

Le script :
1. Installe les d√©pendances (conda, pip, npm)
2. Build le frontend
3. Lance le backend headless (port 5010)
4. Lance le frontend (port 3010)
5. Ouvre Chrome en mode kiosk sur les √©crans

### Configuration Distante
Accessible via `http://<IP>:3010/config` pour :
- S√©lectionner les cam√©ras Nightmare/Dream
- Voir les previews en temps r√©el
- Suivre le statut de bataille

### Web
- `website/app/pages/battle.vue` - Page de combat

## Dark Cosmo

Dark Cosmo est l'antagoniste principal du module Battle. C'est une version corrompue de Cosmo le pingouin qui hante les cauchemars.

### Attaques de Dark Cosmo

| Attaque | √âl√©ment | Contre | Dessin requis |
| :--- | :--- | :--- | :--- |
| **Lightning Strike** | Foudre | Bouclier | üõ°Ô∏è |
| **Fire Blast** | Feu | Eau | üíß |
| **Ice Storm** | Glace | Feu | üî• |
| **Shadow Wave** | Ombre | Lumi√®re | ‚ú® |
| **Void Crush** | Vide | √âp√©e | ‚öîÔ∏è |

### Faiblesse
La faiblesse de Dark Cosmo est r√©v√©l√©e dans l'√©tape 2 du puzzle Stranger Dream :
> "Trouvez le point faible de Dark Cosmo et dites-le lui."

Pour le ramener √† la lumi√®re, les agents doivent l'affaiblir puis utiliser les cages RFID pour le capturer.

### Int√©gration avec les Autres Modules
- **Stranger Dream** : Affiche les indices pour vaincre Dark Cosmo
- **Lost KNN** : Reconna√Æt les dessins des contres via IA (Swift)
- **Operator** : L'op√©rateur peut contr√¥ler le flux de bataille
