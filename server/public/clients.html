<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIFT OS // COMMAND CENTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #000000;
            color: #d4d4d4;
        }

        .terminal-border {
            border: 1px solid #333;
        }

        .terminal-input {
            background-color: #111;
            border: 1px solid #333;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
        }

        .terminal-input:focus {
            outline: none;
            border-color: #666;
            background-color: #1a1a1a;
        }

        .btn-primary {
            background-color: #fff;
            color: #000;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #ccc;
        }

        .btn-secondary {
            border: 1px solid #fff;
            color: #fff;
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: #fff;
            color: #000;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen p-6 flex flex-col gap-6">

    <!-- Header -->
    <header class="flex justify-between items-center border-b border-gray-800 pb-4">
        <div>
            <h1 class="text-2xl font-bold tracking-tighter text-white">RIFT_OPERATION_SERVER</h1>
            <p class="text-xs text-gray-500 mt-1">SYSTEM_STATUS: <span class="text-green-500">ONLINE</span></p>
        </div>
        <div class="test-xs text-right hidden text-gray-600 md:block">
            <p>V 2.0.4-ALPHA</p>
            <p id="clock">00:00:00</p>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1">
        
        <!-- Left Column: Broadcast Controls -->
        <div class="lg:col-span-2 space-y-6">
            <section class="terminal-border p-4 bg-black">
                <h2 class="text-lg font-bold text-white mb-4 border-b border-gray-800 pb-2">Broadcast Command</h2>
                
                <form id="broadcastForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- Counters -->
                    <div class="space-y-4 border-r border-gray-800 pr-4">
                        <h3 class="text-sm font-bold text-gray-400">COUNTERS</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Children Rift Parts</label>
                                <input type="number" name="children_rift_part_count" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Parent Rift Parts</label>
                                <input type="number" name="parent_rift_part_count" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                            </div>
                        </div>
                    </div>

                    <!-- System & Stranger -->
                    <div class="space-y-4">
                        <h3 class="text-sm font-bold text-gray-400">SYSTEM / STRANGER</h3>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Start System</label>
                            <input type="text" name="start_system" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null/true/false">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Recognized Stranger Name</label>
                            <input type="text" name="recognized_stranger_name" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                        </div>
                    </div>

                     <!-- Pinguin -->
                     <div class="md:col-span-2 grid grid-cols-2 gap-4 border-t border-gray-800 pt-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Pinguin Micro</label>
                            <input type="text" name="pinguin_micro" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Pinguin Audio</label>
                            <input type="text" name="pinguin_audio" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                        </div>
                    </div>

                    <!-- Progress Steps -->
                    <div class="md:col-span-2 grid grid-cols-2 gap-8 border-t border-gray-800 pt-4">
                        <!-- Parent Progress -->
                        <div class="space-y-2">
                             <h3 class="text-sm font-bold text-gray-400">PARENT STEPS</h3>
                             <div class="flex items-center gap-2">
                                <span class="text-xs w-12">Step 1</span>
                                <input type="text" name="step_1_parent_sucess" class="terminal-input flex-1 p-1 text-xs" placeholder="null">
                             </div>
                             <div class="flex items-center gap-2">
                                <span class="text-xs w-12">Step 2</span>
                                <input type="text" name="step_2_parent_sucess" class="terminal-input flex-1 p-1 text-xs" placeholder="null">
                             </div>
                             <div class="flex items-center gap-2">
                                <span class="text-xs w-12">Step 3</span>
                                <input type="text" name="step_3_parent_sucess" class="terminal-input flex-1 p-1 text-xs" placeholder="null">
                             </div>
                        </div>
                        
                        <!-- Child Progress -->
                        <div class="space-y-2">
                            <h3 class="text-sm font-bold text-gray-400">CHILD STEPS</h3>
                             <div class="flex items-center gap-2">
                                <span class="text-xs w-12">Step 1</span>
                                <input type="text" name="step_1_enfant_sucess" class="terminal-input flex-1 p-1 text-xs" placeholder="null">
                             </div>
                             <div class="flex items-center gap-2">
                                <span class="text-xs w-12">Step 2</span>
                                <input type="text" name="step_2_enfant_sucess" class="terminal-input flex-1 p-1 text-xs" placeholder="null">
                             </div>
                             <div class="flex items-center gap-2">
                                <span class="text-xs w-12">Step 3</span>
                                <input type="text" name="step_3_enfant_sucess" class="terminal-input flex-1 p-1 text-xs" placeholder="null">
                             </div>
                        </div>
                    </div>

                    <!-- Interactions -->
                    <div class="md:col-span-2 grid grid-cols-2 gap-4 border-t border-gray-800 pt-4">
                         <div>
                            <label class="block text-xs text-gray-500 mb-1">Torch Scanned</label>
                            <input type="text" name="torch_scanned" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Cage on Monster</label>
                            <input type="text" name="cage_is_on_monster" class="terminal-input w-full p-2 text-sm rounded-none" placeholder="null">
                        </div>
                    </div>

                    <!-- Presets -->
                    <div class="md:col-span-2 space-y-3 border-t border-gray-800 pt-4">
                        <h3 class="text-sm font-bold text-gray-400">PRESETS</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <input type="text" name="preset_stranger" class="terminal-input p-2 text-xs" placeholder="Stranger Preset">
                            <input type="text" name="preset_depth" class="terminal-input p-2 text-xs" placeholder="Depth Preset">
                            <input type="text" name="preset_imagination" class="terminal-input p-2 text-xs" placeholder="Imagination Preset">
                            <input type="text" name="preset_ending" class="terminal-input p-2 text-xs" placeholder="Ending Preset">
                        </div>
                    </div>
                </form>

                <div class="mt-6 flex justify-end gap-4">
                    <button onclick="resetForm()" class="btn-secondary px-6 py-3 text-sm font-bold border border-gray-600 hover:border-white">
                        RESET
                    </button>
                    <button onclick="broadcast()" class="btn-primary px-8 py-3 text-sm tracking-wide shadow-lg hover:shadow-white/20">
                        BROADCAST PAYLOAD
                    </button>
                </div>
            </section>
        </div>

        <!-- Right Column: Clients -->
        <div class="space-y-6">
            <section class="terminal-border p-4 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-800">
                    <h2 class="text-lg font-bold text-white">CONNECTED_CLIENTS</h2>
                    <span id="client-count" class="text-2xl font-bold text-white">0</span>
                </div>
                
                <div id="clients-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
                    <!-- Client items injected here -->
                    <div class="animate-pulse flex space-x-4">
                        <div class="flex-1 space-y-2 py-1">
                            <div class="h-4 bg-gray-900 rounded w-3/4"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    </div>

    <!-- Scripts -->
    <script>
        const CLOCK_EL = document.getElementById('clock');
        const CLIENTS_LIST_EL = document.getElementById('clients-list');
        const CLIENT_COUNT_EL = document.getElementById('client-count');

        // Clock
        setInterval(() => {
            const now = new Date();
            CLOCK_EL.textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        // Load Clients
        async function fetchClients() {
            try {
                const res = await fetch('/api/clients');
                const data = await res.json();
                
                CLIENT_COUNT_EL.textContent = data.total;
                CLIENTS_LIST_EL.innerHTML = '';

                data.clients.forEach(client => {
                    const el = document.createElement('div');
                    el.className = 'bg-[#0a0a0a] border border-gray-900 p-3 hover:border-gray-600 transition-colors group';
                    
                    const roleColor = 
                        client.role === 'depth' ? 'text-blue-400' :
                        client.role === 'stranger' ? 'text-green-400' :
                        'text-gray-500';

                    const statusColor = 
                        client.readyState === 1 ? 'bg-green-500' : 'bg-red-500';

                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-600 font-bold mb-1">ID_REF</span>
                                <span class="text-sm text-white font-mono tracking-wide">${client.id}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full ${statusColor} animate-pulse"></div>
                            </div>
                        </div>
                        <div class="mt-3 flex justify-between items-end">
                             <div class="flex flex-col">
                                <span class="text-[10px] text-gray-600 uppercase">Role Definition</span>
                                <span class="text-xs font-bold ${roleColor} uppercase">${client.role}</span>
                            </div>
                             <span class="text-[10px] text-gray-700 font-mono">${client.readyStateText}</span>
                        </div>
                    `;
                    CLIENTS_LIST_EL.appendChild(el);
                });

                if (data.clients.length === 0) {
                     CLIENTS_LIST_EL.innerHTML = '<div class="text-center text-gray-800 text-xs py-10">NO_SIGNALS_DETECTED</div>';
                }

            } catch (e) {
                console.error("Fetch error", e);
            }
        }

        setInterval(fetchClients, 2000);
        fetchClients();

        // Broadcast Logic
        // We connect as a WS client to send the broadcast message
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

        ws.onopen = () => {
            console.log('Dashboard connected to WS');
        };

        function resetForm() {
            document.getElementById('broadcastForm').reset();
        }

        function broadcast() {
            const form = document.getElementById('broadcastForm');
            const formData = new FormData(form);
            const payload = {};

            // Helper to parse inputs
            // Empty string -> null
            // "true"/"false" -> boolean
            // Digits -> number
            for (const [key, value] of formData.entries()) {
                const val = value.trim();
                if (val === "") {
                    payload[key] = null;
                } else if (val.toLowerCase() === "true") {
                    payload[key] = true;
                } else if (val.toLowerCase() === "false") {
                    payload[key] = false;
                } else if (!isNaN(val)) {
                    payload[key] = Number(val);
                } else {
                    payload[key] = val;
                }
            }

            console.log("Broadcasting:", payload);
            
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(payload));
                
                // Visual feedback
                const btn = document.querySelector('.btn-primary');
                const originalText = btn.textContent;
                btn.textContent = "TRANSMITTED";
                btn.style.backgroundColor = "#33ff33"; // Hacker green
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.backgroundColor = "";
                }, 1000);
            } else {
                alert("WebSocket not connected. Please refresh.");
            }
        }
    </script>
</body>
</html>