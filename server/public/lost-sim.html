<!doctype html>
<meta charset="utf-8" />
<title>Lost / Imagination – test</title>
<style>
  body {
    font-family: system-ui, sans-serif;
    padding: 1.5rem;
  }

  button {
    padding: 0.5rem 1rem;
    font-size: 1rem;
    margin-right: 0.5rem;
    margin-top: 0.25rem;
  }

  label {
    display: inline-block;
    margin-right: 0.75rem;
  }

  pre {
    background: #f5f5f5;
    padding: 0.75rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow: auto;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New",
      monospace;
    font-size: 0.85rem;
  }
</style>

<h1>Lost / Imagination – Rift JSON test</h1>

<p>
  This page simulates the <strong>Transit Server</strong> broadcasting the global Rift JSON.
  Lost ESP will auto-start when it receives <code>children_rift_part_count = 2</code> and
  <code>parent_rift_part_count = 2</code>.
</p>

<div>
  <label>
    Children count:
    <input type="number" id="childrenCount" value="0" min="0" />
  </label>

  <label>
    Parent count:
    <input type="number" id="parentCount" value="0" min="0" />
  </label>
</div>

<div style="margin-top: 0.75rem;">
  <button id="sendCurrent">Send Rift JSON (current values)</button>
  <button id="sendStartLost">Send Rift JSON (2 / 2 → start Lost)</button>
  <button id="sendReset">Send Rift JSON (0 / 0 → reset counts)</button>
</div>

<pre id="log"></pre>

<script>
  const logEl = document.getElementById("log");
  const log = (m) => {
    const ts = new Date().toISOString().split("T")[1].replace("Z", "");
    logEl.textContent += `[${ts}] ${m}\n`;
    logEl.scrollTop = logEl.scrollHeight;
  };

  const childrenInput = document.getElementById("childrenCount");
  const parentInput = document.getElementById("parentCount");

  // Change this URL if your transit server is on another host/port
  const ws = new WebSocket("ws://localhost:3000/ws");

  ws.onopen = () => {
    log("WS open");

    // Optional: send an initial 0/0 JSON when the page connects
    sendRiftState(0, 0);
  };

  ws.onclose = () => log("WS closed");
  ws.onerror = (e) => log("WS error: " + (e.message || "unknown"));
  ws.onmessage = (e) => log("<< " + e.data);

  function sendRiftState(childrenCount, parentCount, extra = {}) {
    const payload = {
      // Rift table
      children_rift_part_count: childrenCount,
      parent_rift_part_count: parentCount,

      // Stranger (not really used by Lost controller but included for shape)
      start_system: null,
      recognized_stranger_name: null,
      pinguin_micro: null,
      pinguin_audio: null,

      // Depth
      step_1_parent_sucess: null,
      step_2_parent_sucess: null,
      step_3_parent_sucess: null,
      step_1_enfant_sucess: null,
      step_2_enfant_sucess: null,
      step_3_enfant_sucess: null,

      // Imagination (Lost)
      torch_scanned: null,
      cage_is_on_monster: null,

      // Scenography
      preset_stranger: null,
      preset_depth: null,
      preset_imagination: null,
      preset_ending: null,


      ...extra,
    };

    const msg = {
      type: "rift_state",
      value: payload,
    };

    const json = JSON.stringify(msg);
    ws.send(json);
    log(">> " + json);
  }

  // --- UI handlers ---------------------------------------------------------
  document.getElementById("sendCurrent").onclick = () => {
    const c = Number(childrenInput.value || 0);
    const p = Number(parentInput.value || 0);
    sendRiftState(c, p);
  };

  document.getElementById("sendStartLost").onclick = () => {
    // Force 2/2 for Lost auto-start
    childrenInput.value = "2";
    parentInput.value = "2";
    sendRiftState(2, 2);
  };

  document.getElementById("sendReset").onclick = () => {
    childrenInput.value = "0";
    parentInput.value = "0";
    sendRiftState(0, 0, {
      // Optionally clear scenography flags
      preset_imagination: null,
    });
  };
</script>
